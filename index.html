<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Debt Tracker ‚Äî Light</title>
<link rel="manifest" href="manifest.json" />
<style>
  :root{
    --bg: #ffffff;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #f59e0b; /* amber */
    --accent-2: #fb923c; /* orange */
    --radius: 12px;
    --border: #e6e6e9;
  }
  *{box-sizing:border-box}
  body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#fafafa; color:#111}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#18201f}
  h1{font-size:18px;margin:0;color:#b45309}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .grid{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:12px}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(16,24,40,0.03)}
  .small{font-size:13px;color:var(--muted)}
  input, select, button, textarea{padding:10px;border-radius:8px;border:1px solid var(--border);width:100%;box-sizing:border-box;background:white}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#08201a;border:none;padding:10px;border-radius:8px;font-weight:700}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px;border-radius:8px}

  .metric{display:flex;justify-content:space-between;padding:10px;border-radius:8px;background:#fff;border:1px solid var(--border);margin-bottom:10px}
  .metric h3{margin:0;font-size:13px;color:var(--muted)}
  .metric .val{font-weight:700;color:var(--accent)}

  canvas{width:100%;height:140px;background:transparent;border-radius:8px}

  .history-list{max-height:300px;overflow:auto}
  .entry{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fff;border:1px solid var(--border);margin-bottom:8px}
  .nav-actions{display:flex;gap:8px;align-items:center}

  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">DT</div>
      <div>
        <h1>Debt Tracker ‚Äî Secure</h1>
        <p class="lead">Light mode ‚Ä¢ Offline AES-256 encryption ‚Ä¢ Focus: move from loan to savings</p>
      </div>
    </div>
    <div class="nav-actions">
      <button id="toggleTheme" class="ghost" style="display:none">Theme</button>
      <button id="showAbout" class="ghost">About</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: controls -->
    <div>
      <div class="card" id="lockedUI">
        <strong>Secure Storage</strong>
        <p class="small" style="margin-top:6px">Create a <strong>Security Password</strong> to encrypt your data locally. This password never leaves your device. If forgotten, data cannot be recovered.</p>

        <div style="margin-top:12px">
          <label class="small">Create Security Password</label>
          <div class="row">
            <input id="newPass1" type="password" placeholder="Enter new Security Password" autocomplete="new-password">
            <button id="toggleNew1" class="ghost">üëÅ</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label class="small">Confirm Security Password</label>
          <div class="row">
            <input id="newPass2" type="password" placeholder="Confirm Security Password" autocomplete="new-password">
            <button id="toggleNew2" class="ghost">üëÅ</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="createBtn" class="primary">Create Encrypted Storage</button>
          <button id="recoverHelp" class="ghost">Need help?</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">

        <div>
          <strong>Unlock Storage</strong>
          <p class="small" style="margin-top:6px">Enter your Security Password to unlock your encrypted data.</p>
        </div>

        <div style="margin-top:8px">
          <label class="small">Security Password</label>
          <div class="row">
            <input id="passphrase" type="password" placeholder="Enter Security Password to unlock" autocomplete="current-password">
            <button id="toggleUnlock" class="ghost">üëÅ</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="unlockBtn" class="primary">Unlock</button>
            <button id="wipeBtn" class="ghost">Factory Reset</button>
          </div>

          <p class="small" style="margin-top:10px">Tip: pick a secure phrase and store it in a password manager / safe place.</p>
        </div>
      </div>
      <!-- Profile & Settings -->
      <div class="card" style="margin-top:12px" id="appUI" aria-hidden="true">
        <strong>Onboarding ‚Äî Quick Profile</strong>
        <p class="small" style="margin-top:6px">Enter monthly income, EMIs and target months to be debt-free.</p>

        <div style="margin-top:10px"><label class="small">Monthly Net Income (‚Çπ)</label><input id="income" type="number" placeholder="e.g., 120000"></div>
        <div style="margin-top:8px"><label class="small">Total Monthly EMI (‚Çπ)</label><input id="emi" type="number" placeholder="e.g., 25951"></div>
        <div style="margin-top:8px"><label class="small">Fixed Needs Total (‚Çπ)</label><input id="fixedNeeds" type="number" placeholder="Rent + utilities e.g., 30000"></div>
        <div style="margin-top:8px"><label class="small">Target months to debt-free</label><input id="targetMonths" type="number" placeholder="e.g., 18"></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="saveProfile" class="primary">Save Profile & Forecast</button>
          <button id="exportBtn" class="ghost">Export Backup</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Add Loan</strong>
        <p class="small" style="margin-top:6px">Segregate loans: Personal, Home, Vehicle, Credit Card, Consumer.</p>
        <div style="margin-top:8px" class="row"><input id="loanType" placeholder="Type (Personal/Home)"><input id="loanOutstanding" type="number" placeholder="Outstanding (‚Çπ)"></div>
        <div style="margin-top:8px" class="row"><input id="loanEMI" type="number" placeholder="EMI (‚Çπ)"><input id="loanRate" type="number" placeholder="Rate (%)"></div>
        <div style="margin-top:8px" class="row"><input id="loanTerm" type="number" placeholder="Remain months"><input id="loanName" placeholder="Lender"></div>
        <div style="margin-top:10px"><button id="addLoanBtn" class="primary">Add Loan</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Add Expense</strong>
        <p class="small" style="margin-top:6px">Track spending and flag waste merchants (Swiggy, Amazon, Flipkart...)</p>
        <div style="margin-top:8px"><input id="expMerchant" placeholder="Merchant (e.g., Swiggy)"></div>
        <div style="margin-top:8px" class="row"><input id="expAmount" type="number" placeholder="Amount (‚Çπ)"><input id="expDate" type="date"></div>
        <div style="margin-top:8px"><input id="expCategory" placeholder="Category (Food/Shopping/Travel)"></div>
        <div style="margin-top:10px"><button id="addExpenseBtn" class="primary">Add Expense</button></div>
      </div>
    </div>

    <!-- RIGHT column: dashboard -->
    <aside>
      <div class="card">
        <div class="metric"><h3>Income</h3><div class="val" id="metricIncome">‚Äî</div></div>
        <div class="metric"><h3>Total EMI</h3><div class="val" id="metricEMI">‚Äî</div></div>
        <div class="metric"><h3>Total Debt</h3><div class="val" id="metricDebt">‚Äî</div></div>

        <canvas id="donutCanvas" aria-label="50-30-20 chart"></canvas>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>6-Month Action Plan</strong>
        <div id="sixMonth" class="small" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>History</strong>
        <div class="history-list" id="history" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Security</strong>
        <p class="small" style="margin-top:6px">Export encrypted backup or clear local data. Backups are encrypted with your Security Password.</p>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="downloadBackup" class="ghost">Download Backup</button>
          <button id="clearData" class="ghost">Clear Local Data</button>
        </div>
      </div>
    </aside>
  </div>

  <footer>Offline & encrypted ‚Ä¢ AES-256-GCM local encryption ‚Ä¢ No cloud unless you export encrypted backup</footer>
</div>
<script>
/* ---------- Crypto & storage keys ---------- */
const PBKDF2_ITER = 200000;
const SALT_KEY = "debt_salt_light_v1";
const ENCRYPTED_KEY = "debt_encrypted_light_v1";

/* ----- binary/text helpers ----- */
function str2ab(s){ return new TextEncoder().encode(s); }
function ab2str(ab){ return new TextDecoder().decode(ab); }
function ab2b64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b642ab(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }

/* ----- key derivation & AES-GCM (AES-256) ----- */
async function deriveKey(pass, salt){
  const base = await crypto.subtle.importKey("raw", str2ab(pass), {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2", salt, iterations:PBKDF2_ITER, hash:"SHA-256"}, base, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
}
async function encryptObject(obj, key){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const raw = str2ab(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, raw);
  return { iv: ab2b64(iv.buffer), data: ab2b64(cipher) };
}
async function decryptObject(blob, key){
  const iv = b642ab(blob.iv);
  const data = b642ab(blob.data);
  const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
  return JSON.parse(ab2str(plain));
}

/* ----- local storage helpers ----- */
function saveEncryptedBlob(obj){ localStorage.setItem(ENCRYPTED_KEY, JSON.stringify(obj)); }
function readEncryptedBlob(){ const v = localStorage.getItem(ENCRYPTED_KEY); return v?JSON.parse(v):null; }
function storeSalt(buf){ localStorage.setItem(SALT_KEY, ab2b64(buf)); }
function readSalt(){ const s = localStorage.getItem(SALT_KEY); return s?b642ab(s):null; }

/* ---------- App state ---------- */
let unlockedKey = null;
let appState = {
  incomeMonthly:0,
  loans:[],
  fixedNeedsTotal:0,
  history:[],
  settings:{ wasteMerchants:["swiggy","zomato","amazon","flipkart","myntra","ajio","blinkit","bajaj","meesho","nykaa"] },
  userGoals:{ targetDebtFreeMonths:18 },
  guidanceMode:'balanced'
};

/* ---------- Utilities ---------- */
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function money(x){ return '‚Çπ' + (Math.round(x)).toLocaleString('en-IN'); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

/* ---------- Loan & budgeting logic ---------- */
function amortizationCalc(P, annualRate, n){
  P=Number(P); annualRate=Number(annualRate); n=Number(n);
  if(n<=0 || P<=0) return { monthlyPayment:0, monthsRemaining:0, totalInterestRemaining:0 };
  const r = annualRate/100/12;
  const EMI = r===0 ? P/n : (P * r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
  return { monthlyPayment: EMI, monthsRemaining: n, totalInterestRemaining: (EMI*n)-P };
}
function computeLoanAggregates(){
  let totalOutstanding=0, totalEMI=0, totalInterest=0;
  appState.loans.forEach(l=>{
    totalOutstanding += Number(l.principalOutstanding||0);
    totalEMI += Number(l.emi||0);
    const a = amortizationCalc(Number(l.principalOutstanding||0), Number(l.rate||0), Number(l.remainingMonths||0));
    totalInterest += a.totalInterestRemaining;
  });
  return { totalOutstanding, totalEMI, totalInterest };
}
function computeBucketsDetailed(){
  const income = Number(appState.incomeMonthly||0);
  const needs = Math.max(0.5 * income, Number(appState.fixedNeedsTotal||0));
  const wants = 0.3 * income;
  const savings = 0.2 * income;
  const loanEMI = computeLoanAggregates().totalEMI;
  const adjustedNeeds = needs + loanEMI;
  const monthlySafeSpend = adjustedNeeds + wants;
  const d = new Date(); const days = daysInMonth(d.getFullYear(), d.getMonth()+1);
  return { income, needs, wants, savings, loanEMI, adjustedNeeds, monthlySafeSpend, dailySafe: monthlySafeSpend/days, weeklySafe: monthlySafeSpend/4 };
}

/* ---------- Spending patterns & warnings ---------- */
function spendingPatterns(){
  const now = new Date();
  const last30 = new Date(); last30.setDate(now.getDate()-30);
  const entries30 = appState.history.filter(h => new Date(h.date) >= last30);
  const total30 = entries30.reduce((s,e)=>s+Number(e.amount||0),0);
  const avgDaily = total30/30;
  const catTotals = {};
  appState.history.forEach(e=>{
    const c = (e.category||'Misc').toLowerCase();
    catTotals[c] = (catTotals[c]||0) + Number(e.amount||0);
  });
  return { total30, avgDaily, catTotals };
}
function isWasteMerchant(m){ if(!m) return false; const mm = (m||'').toLowerCase(); return (appState.settings.wasteMerchants||[]).some(w => mm.includes(w)); }

/* ---------- 6-month plan & forecast ---------- */
function generate6MonthPlan(){
  const b = computeBucketsDetailed();
  const agg = computeLoanAggregates();
  const targetMonths = Number(appState.userGoals.targetDebtFreeMonths||18);
  const currentTotalOutstanding = agg.totalOutstanding;
  const neededMonthlyPrincipal = currentTotalOutstanding / Math.max(1,targetMonths);
  const currentEMI = agg.totalEMI;
  const approxExtraNeeded = Math.max(0, neededMonthlyPrincipal - Math.max(0, currentEMI*0.6));
  let monthExtra = Math.max(0, Math.round(approxExtraNeeded*0.6));
  const plan = [];
  for(let i=1;i<=6;i++){
    const suggestedCut = Math.round(b.wants * (0.08 + 0.05*(i-1)));
    const suggestedExtra = monthExtra + Math.round(suggestedCut * 0.6);
    plan.push({ monthIndex:i, suggestedCut, suggestedExtra, projectedDebtReduction: suggestedExtra*i });
  }
  return { plan, neededMonthlyPrincipal, approxExtraNeeded };
}

/* ---------- Persistence: initialize/unlock/save ---------- */
async function initializeNew(pass){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  storeSalt(salt.buffer);
  unlockedKey = await deriveKey(pass, salt.buffer);
  await saveState();
}
async function unlockWithPass(pass){
  const salt = readSalt();
  if(!salt) throw new Error('No storage found. Create one first.');
  unlockedKey = await deriveKey(pass, salt);
  const blob = readEncryptedBlob();
  if(!blob) throw new Error('No encrypted data found.');
  const obj = await decryptObject(blob, unlockedKey);
  appState = obj;
  showAppUI();
  renderAll();
}
async function saveState(){
  if(!unlockedKey) throw new Error('Not unlocked');
  const enc = await encryptObject(appState, unlockedKey);
  saveEncryptedBlob(enc);
}

/* ---------- export & wipe ---------- */
function exportEncryptedBackup(){
  const blob = readEncryptedBlob(); if(!blob){ alert('No data to export'); return; }
  const dataStr = JSON.stringify({ salt: localStorage.getItem(SALT_KEY), blob });
  const url = URL.createObjectURL(new Blob([dataStr], { type:'application/json' }));
  const a = document.createElement('a'); a.href = url; a.download='debt_backup_encrypted.json'; a.click(); URL.revokeObjectURL(url);
}
function wipeAllData(){
  localStorage.removeItem(SALT_KEY);
  localStorage.removeItem(ENCRYPTED_KEY);
  appState = { incomeMonthly:0, loans:[], fixedNeedsTotal:0, history:[], settings:{ wasteMerchants:["swiggy","zomato","amazon","flipkart","myntra","ajio","blinkit","bajaj","meesho","nykaa"] }, userGoals:{ targetDebtFreeMonths:18 } };
  hideAppUI();
  alert('Local data cleared');
}

/* ---------- UI helpers & handlers ---------- */
function showAppUI(){ document.getElementById('appUI').setAttribute('aria-hidden','false'); }
function hideAppUI(){ document.getElementById('appUI').setAttribute('aria-hidden','true'); }

document.getElementById('createBtn').addEventListener('click', async ()=>{
  const p1 = document.getElementById('newPass1').value;
  const p2 = document.getElementById('newPass2').value;
  if(!p1 || !p2){ alert('Enter Security Password twice'); return; }
  if(p1 !== p2){ alert('Security Passwords do not match'); return; }
  await initializeNew(p1);
  showAppUI();
  await saveState();
  renderAll();
  alert('Encrypted storage created. Remember your Security Password.');
});

document.getElementById('unlockBtn').addEventListener('click', async ()=>{
  const p = document.getElementById('passphrase').value;
  try{
    await unlockWithPass(p);
    document.getElementById('passphrase').value = '';
  } catch(e){
    alert('Unlock failed: ' + e.message);
  }
});

document.getElementById('recoverHelp').addEventListener('click', ()=> {
  alert('Your Security Password encrypts your data on this device. If forgotten, data cannot be recovered. Use a password manager or write it down in a safe place.');
});
document.getElementById('toggleNew1').addEventListener('click', ()=> toggleInputVisibility('newPass1'));
document.getElementById('toggleNew2').addEventListener('click', ()=> toggleInputVisibility('newPass2'));
document.getElementById('toggleUnlock').addEventListener('click', ()=> toggleInputVisibility('passphrase'));
document.getElementById('wipeBtn').addEventListener('click', ()=> { if(confirm('Clear all local data?')) wipeAllData(); });
document.getElementById('exportBtn').addEventListener('click', ()=> exportEncryptedBackup());
document.getElementById('downloadBackup').addEventListener('click', ()=> exportEncryptedBackup());
document.getElementById('clearData').addEventListener('click', ()=> { if(confirm('Clear all local data?')) wipeAllData(); });

/* add Loan */
document.getElementById('addLoanBtn').addEventListener('click', ()=>{
  const t = document.getElementById('loanType').value || 'Personal';
  const p = Number(document.getElementById('loanOutstanding').value) || 0;
  const emi = Number(document.getElementById('loanEMI').value) || 0;
  const rate = Number(document.getElementById('loanRate').value) || 0;
  const term = Number(document.getElementById('loanTerm').value) || 0;
  const name = document.getElementById('loanName').value || '';
  const ln = { id: uid('loan'), type: t, lender: name, principalOutstanding: p, emi: emi, rate: rate, remainingMonths: term };
  appState.loans.push(ln);
  saveState().then(()=> renderAll()).catch(()=> renderAll());
});

/* add Expense */
document.getElementById('addExpenseBtn').addEventListener('click', ()=>{
  const m = document.getElementById('expMerchant').value || 'Unknown';
  const amt = Number(document.getElementById('expAmount').value) || 0;
  const d = document.getElementById('expDate').value || todayISO();
  const cat = document.getElementById('expCategory').value || 'Misc';
  if(!amt){ alert('Enter amount'); return; }
  const e = { id: uid('e'), merchant: m, amount: amt, date: d, category: cat };
  addExpenseAndEnforce(e);
  document.getElementById('expMerchant').value=''; document.getElementById('expAmount').value=''; document.getElementById('expDate').value=''; document.getElementById('expCategory').value='';
});

/* add expense logic + warnings */
function addExpenseAndEnforce(exp){
  appState.history.unshift(exp);
  const b = computeBucketsDetailed();
  const now = new Date(exp.date);
  const month = now.getMonth(), year = now.getFullYear();
  const monthEntries = appState.history.filter(h=>{ const d=new Date(h.date); return d.getMonth()===month && d.getFullYear()===year; });
  const monthSpent = monthEntries.reduce((s,e)=>s+Number(e.amount||0),0);
  const todayEntries = appState.history.filter(h => new Date(h.date).toDateString() === new Date(exp.date).toDateString());
  const todaySpent = todayEntries.reduce((s,e)=>s+Number(e.amount||0),0);
  const sevenDaysAgo=new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);
  const weekEntries = appState.history.filter(h => new Date(h.date) >= sevenDaysAgo);
  const weekSpent = weekEntries.reduce((s,e)=>s+Number(e.amount||0),0);

  if(todaySpent > b.dailySafe) showWarning('STOP. You crossed your DAILY safe spend by ‚Çπ' + Math.round(todaySpent - b.dailySafe));
  if(weekSpent > b.weeklySafe) showWarning('ALERT. Weekly spend exceeded safe limit by ‚Çπ' + Math.round(weekSpent - b.weeklySafe));
  if(monthSpent > b.monthlySafeSpend) showWarning('RISK: You exceeded your MONTHLY safe spend by ‚Çπ' + Math.round(monthSpent - b.monthlySafeSpend));
  if(isWasteMerchant(exp.merchant)) showWarning('WASTE SPEND DETECTED: This purchase may be unnecessary and affects your debt plan.');

  saveState().then(()=> renderAll());
  return { monthSpent, todaySpent, weekSpent };
}
function showWarning(msg){ alert(msg); }

/* rendering functions */
function drawDonutCanvas(id, vals){
  const c = document.getElementById(id);
  if(!c) return;
  const ctx = c.getContext('2d');
  const w = c.width = c.offsetWidth;
  const h = c.height = 140;
  ctx.clearRect(0,0,w,h);
  const total = vals.reduce((s,v)=>s+v,0)||1;
  let start = -0.5*Math.PI;
  const cx = w/2, cy = h/2, r = Math.min(w,h)/3;
  const cols = ['#f59e0b','#fb923c','#fde68a'];
  for(let i=0;i<vals.length;i++){
    const slice = (vals[i]/total)*(2*Math.PI);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+slice); ctx.closePath();
    ctx.fillStyle = cols[i%cols.length]; ctx.fill();
    start += slice;
  }
  ctx.fillStyle = '#333'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.fillText('50-30-20',cx,cy+6);
}

function renderAll(){
  const b = computeBucketsDetailed();
  const agg = computeLoanAggregates();
  document.getElementById('metricIncome').innerText = b.income ? money(b.income) : '‚Äî';
  document.getElementById('metricEMI').innerText = agg.totalEMI ? money(agg.totalEMI) : '‚Äî';
  document.getElementById('metricDebt').innerText = agg.totalOutstanding ? money(agg.totalOutstanding) : '‚Äî';
  drawDonutCanvas('donutCanvas',[b.adjustedNeeds||0, b.wants||0, b.savings||0]);
  renderLoans();
  renderHistory();
  render6Month();
}

function renderLoans(){
  const el = document.getElementById('loanList');
  if(!el){
    // create if missing
    const container = document.createElement('div');
    container.id='loanList';
    document.querySelector('.card')?.appendChild(container);
  }
  const list = document.getElementById('loanList'); list.innerHTML='';
  appState.loans.forEach(ln=>{
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `<div><strong>${escapeHtml(ln.type||'Loan')}</strong><div class="small">${escapeHtml(ln.lender||'')} ¬∑ ${ln.remainingMonths} months</div></div>
                     <div style="text-align:right"><div>${money(ln.principalOutstanding)}</div><div style="margin-top:6px"><button onclick="prepayPrompt('${ln.id}')" class="ghost">Prepay</button></div></div>`;
    list.appendChild(div);
  });
}

function prepayPrompt(id){
  const amt = prompt('Enter extra principal payment amount (‚Çπ):');
  if(!amt) return;
  const ln = appState.loans.find(l=>l.id===id);
  if(!ln) return;
  ln.principalOutstanding = Math.max(0, Number(ln.principalOutstanding) - Number(amt));
  saveState().then(()=> renderAll());
}

function renderHistory(){
  const el = document.getElementById('history'); el.innerHTML='';
  appState.history.forEach(h=>{
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `<div><strong>${escapeHtml(h.merchant)}</strong><div class="small">${h.date} ¬∑ ${escapeHtml(h.category||'Misc')}</div></div>
                     <div style="text-align:right"><div>${money(h.amount)}</div><div style="margin-top:6px"><button onclick="undoById('${h.id}')" class="ghost">Undo</button></div></div>`;
    el.appendChild(div);
  });
}
function undoById(id){ appState.history = appState.history.filter(h=>h.id!==id); saveState().then(()=> renderAll()); }

/* 6-month plan */
function render6Month(){
  const container = document.getElementById('sixMonth'); container.innerHTML='';
  const plan = generate6MonthPlan();
  let out = `<div class="small">Suggested monthly cuts & extras to repay loans faster</div>`;
  plan.plan.forEach(p=>{
    out += `<div class="entry" style="margin-top:8px"><div><strong>Month ${p.monthIndex}</strong><div class="small">Cut wants: ${money(p.suggestedCut)} ¬∑ Extra to loans: ${money(p.suggestedExtra)}</div></div></div>`;
  });
  container.innerHTML = out;
}

/* helpers */
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toggleInputVisibility(id){ const el = document.getElementById(id); if(!el) return; el.type = el.type === 'password' ? 'text' : 'password'; }

/* init on load */
window.addEventListener('load', ()=>{
  const blob = readEncryptedBlob();
  if(blob){
    // encrypted data exists ‚Äî show locked UI for unlock
    hideAppUI();
  } else {
    // no storage yet ‚Äî show create UI but keep app UI hidden until create/unlock
    hideAppUI();
  }
  // attempt to register service worker (optional)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
});

/* expose a few functions globally for console testing */
window.computeLoanAggregates = computeLoanAggregates;
window.generate6MonthPlan = generate6MonthPlan;
window.renderAll = renderAll;
window.exportEncryptedBackup = exportEncryptedBackup;
window.saveState = saveState;
</script>
</body>
</html>
